<body>
    <button class="begin" id="presenter">Presenter</button>
    <button class="begin" id="controller">Controller</button>

    <div id="id"></div>
    <h2>Local</h2>
    <video id="video" style="width: 640px; height: 480px;" autoplay></video>
    <h2>Remote</h2>
    <video id="videoRemote" style="width: 640px; height: 480px;" autoplay></video>
</body>
<script>

    window.RTCPeerConnection = window.RTCPeerConnection || webkitRTCPeerConnection;
    window.RTCIceCandidate = window.RTCIceCandidate || webkitRTCIceCandidate;
    window.RTCSessionDescription = window.RTCSessionDescription || webkitRTCSessionDescription;

    function establishRTC(ws, isCaller) {
        var video = document.getElementById('video');
        var remote = document.getElementById('videoRemote');
        var pc = new RTCPeerConnection();

        ws.onmessage = function(msg) {
            var m = JSON.parse(msg.data);
            if (m.type == 'ice') {
                pc.addIceCandidate(new RTCIceCandidate(m.ice));
            } else if (m.type == 'sdp') {
                pc.setRemoteDescription(new RTCSessionDescription(m.sdp));
            } else if (m.type == 'error') {
                alert('Error: ' + m.message);
            }
        };

        pc.onicecandidate = function (evt) {
            ws.send({ type: 'ice', ice: evt.candidate });
        };

        // once remote stream arrives, show it in the remote video element
        pc.onaddstream = function (evt) {
            remote.src = URL.createObjectURL(evt.stream);
        };

        getUserMedia({ video: true, audio: true }, function gumSuccess(stream){
            if (URL.createObjectURL) {
                video.src = URL.createObjectURL(stream);
            } else {
                video.src = stream;
            }

            if (isCaller) {
                pc.createOffer(gotDescription);
            }  else {
                pc.createAnswer(pc.remoteDescription, gotDescription);
            }

            function gotDescription(desc) {
                pc.setLocalDescription(desc);
                ws.send({ type: 'sdp', 'sdp': desc });
            }
        }, function gumError(e){
            alert('getUserMedia error: ' + e);
        })
    }

    function beginAs(mode) {
        var ws = new WebSocket('ws://' + window.location.host);

        ws.send = (function(o) {
            return function (data) {
                if (typeof data == 'object') {
                    return o.call(this, JSON.stringify(data))
                } else {
                    return o.apply(this, arguments);
                }
            }
        })(ws.send);

        ws.onopen = function() {
            if (mode == 'presenter') {
                var id = prompt('Enter controller id');
                ws.send({ type: mode, id: id });
            } else {
                ws.send({type: mode});
            }
            ws.onmessage = function(msg) {
                var m = JSON.parse(msg.data);
                if (m.type == 'id') {
                    document.getElementById('id').appendChild(document.createTextNode(m.id));
                } else if (m.type == 'startSession') {
                    establishRTC(this, mode == 'controller');
                } else if (m.type == 'error') {
                    alert('Error: ' + m.message);
                }
            }
        }
    }

    document.body.addEventListener('click', function(e){
        if (e.target.className == 'begin') {
            beginAs(e.target.id);
        }
        var btns = document.body.getElementsByTagName('button');
        for(var i = 0, l = btns.length; i < l; i++) {
            btns[i].disabled = true;
        }
    }, false);

</script>

